name: Ensure Uptime Line Uncommented

on:
  pull_request:
    branches:
      - main

jobs:
  check-line:
    runs-on: [self-hosted, homelab]
    steps:
      - uses: actions/checkout@v3

      - name: Ensure main.cs exists
        run: |
          if [ ! -f "main.cs" ]; then
            echo "❌ main.cs not found!"
            exit 1
          fi

      - name: Check main.cs for uncommented line
        env:
          REQUIRED_LINE: "Uptime.StartHttpListener();"
        run: |
          FILE="main.cs"

          # Find all lines containing the required code
          if ! grep -F "${REQUIRED_LINE}" "$FILE" > /dev/null; then
            echo "❌ Required line '${REQUIRED_LINE}' is missing entirely"
            exit 1
          fi

          # Check each line to see if at least one is not commented
          FOUND_UNCOMMENTED=false
          
          while IFS= read -r line; do
            # Remove leading whitespace and check if it starts with //
            trimmed=$(echo "$line" | sed 's/^[[:space:]]*//')
            if [[ ! "$trimmed" =~ ^// ]]; then
              FOUND_UNCOMMENTED=true
              echo "✅ Found uncommented line: $line"
            else
              echo "Found commented line: $line"
            fi
          done < <(grep -F "${REQUIRED_LINE}" "$FILE")

          if [ "$FOUND_UNCOMMENTED" = false ]; then
            echo "❌ All instances of '${REQUIRED_LINE}' are commented out"
            exit 1
          fi

          echo "✅ At least one uncommented instance of '${REQUIRED_LINE}' found"