name: Ensure Uptime Line Uncommented

on:
  pull_request:
    branches:
      - main

jobs:
  check-line:
    runs-on: [self-hosted, homelab]
    steps:
      - uses: actions/checkout@v3

      - name: Ensure main.cs exists
        run: |
          if [ ! -f "main.cs" ]; then
            echo "❌ main.cs not found!"
            exit 1
          fi

      - name: Check main.cs for uncommented line
        env:
          REQUIRED_LINE: "Uptime.StartHttpListener();"
        run: |
          FILE="main.cs"

          # Match REQUIRED_LINE with optional leading/trailing whitespace
          # but ensure it is not preceded by //
          if ! grep -Eq "^[[:space:]]*${REQUIRED_LINE}([[:space:]]*(//.*)?)?$" "$FILE"; then
            echo "❌ Required line '${REQUIRED_LINE}' is missing or commented out"
            echo "Here are the lines I found:"
            grep -n "${REQUIRED_LINE}" "$FILE" || echo "No occurrences at all"
            exit 1
          fi

          echo "✅ Required line '${REQUIRED_LINE}' is present and uncommented."